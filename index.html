<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Encodage patients — Supabase</title>
<style>
:root{--accent:#0b76ef;--bg:#f6f8fb;--card:#fff;--muted:#6b7280}
body{font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;margin:0;background:var(--bg);color:#111}
header{background:linear-gradient(90deg,var(--accent),#3aa0ff);color:white;padding:18px 24px;display:flex;align-items:center;justify-content:space-between}
header h1{margin:0;font-size:18px}
.container{max-width:1100px;margin:28px auto;padding:16px}
.grid{display:grid;grid-template-columns:320px 1fr;gap:18px}
.card{background:var(--card);padding:16px;border-radius:10px;box-shadow:0 6px 18px rgba(16,24,40,0.06)}
.menu button{display:block;width:100%;text-align:left;padding:10px;border:0;background:none;border-radius:8px;margin-bottom:6px;cursor:pointer}
.menu button.active{background:#eef6ff;color:var(--accent);font-weight:600}
label{display:block;margin-top:10px;font-weight:600}
input[type=text],input[type=date],select,textarea,input[type=number]{width:100%;padding:8px;margin-top:6px;border-radius:6px;border:1px solid #e6e9ef}
textarea{min-height:80px}
.row{display:flex;gap:10px}
.actions{margin-top:12px;display:flex;gap:8px}
button.primary{background:var(--accent);color:white;padding:10px 14px;border:0;border-radius:8px;cursor:pointer}
button.ghost{background:transparent;border:1px solid #e6e9ef;padding:10px 12px;border-radius:8px;cursor:pointer}
.patient-item{padding:8px;border-radius:6px;border:1px solid #f0f3f7;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center}
.muted{color:var(--muted);font-size:13px}
.report{white-space:pre-wrap;background:#fafcff;padding:12px;border-radius:8px;border:1px dashed #e6f0ff}
.search-bar{margin-bottom:10px;padding:6px;width:100%;border-radius:6px;border:1px solid #e6e9ef}
</style>
</head>
<body>
<header>
  <h1>Encodage patients — Supabase</h1>
  <div class="muted">Version améliorée</div>
</header>

<div class="container">
  <div class="grid">
    <aside class="card">
      <div class="menu">
        <button id="nav-list" class="active">Liste patients</button>
        <button id="nav-new">Nouveau patient</button>
      </div>
      <input type="text" id="searchPatient" class="search-bar" placeholder="Rechercher un patient...">
      <div id="patientList" class="list"></div>
    </aside>

    <main>
      <!-- Liste -->
      <section id="view-list" class="card">
        <h2>Liste des patients</h2>
        <div id="listContent"></div>
      </section>

      <!-- Nouveau / Modifier patient -->
      <section id="view-new" class="card" style="display:none;">
        <h2>Créer / Modifier un patient</h2>
        <form id="patientForm">
          <label>Prénom Nom du SAMS</label>
          <input type="text" id="samsName" name="samsName" required>
          <label>Prénom Nom du patient</label>
          <input type="text" id="patientName" name="patientName" required>
          <div class="row">
            <div style="flex:1">
              <label>Date de naissance</label>
              <input type="date" id="dob" name="dob">
            </div>
            <div style="width:160px">
              <label>Profession</label>
              <input type="text" id="profession" name="profession">
            </div>
          </div>
          <label>Blessures (une par ligne)</label>
          <textarea id="blessures" name="blessures" placeholder="Ex: Fracture tibia - Légère"></textarea>
          <label>Raison de l’hospitalisation</label>
          <textarea id="raison" name="raison"></textarea>
          <label>Examens</label>
          <textarea id="examens" name="examens" placeholder="Ex: IRM x1, Radio x2"></textarea>
          <div class="actions">
            <button class="primary" type="submit">Enregistrer</button>
            <button type="button" id="clearForm" class="ghost">Effacer</button>
          </div>
        </form>
      </section>

      <!-- Dossier patient -->
      <section id="view-dossier" class="card" style="display:none;">
        <h2>Dossier patient</h2>
        <div id="rapportContent" class="report"></div>
        <div class="actions">
          <button id="editPatient" class="ghost">Modifier</button>
          <button id="deletePatient" class="ghost" style="border-color:red;color:red">Supprimer</button>
          <button id="addInvoice" class="primary">Ajouter facture</button>
          <button id="printReport" class="primary">Imprimer</button>
        </div>
      </section>

    </main>
  </div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

const SUPABASE_URL = "https://sevrfgivcpefyykuffti.supabase.co"
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNldnJmZ2l2Y3BlZnl5a3VmZnRpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5NDI1NTMsImV4cCI6MjA3ODUxODU1M30.YZnkSHsVWKQEhfU7xYfWyTFmtkM28Zuzdu7Y1sjBXQc"
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY)

const views = {
  list: document.getElementById('view-list'),
  new: document.getElementById('view-new'),
  dossier: document.getElementById('view-dossier')
}
const navButtons = ['list','new'].map(id => document.getElementById('nav-'+id))
function show(view){
  Object.values(views).forEach(v=>v.style.display='none')
  views[view].style.display='block'
  navButtons.forEach(b=>b.classList.remove('active'))
  if(view!=='dossier') document.getElementById('nav-'+view).classList.add('active')
}

let patients=[], current=null

async function loadPatients(){
  const { data, error } = await supabase.from('patients').select('*').order('id')
  if(error) console.error(error)
  patients = data||[]
  renderList()
}

function renderList(filter=""){
  const listDiv=document.getElementById('patientList')
  listDiv.innerHTML=""
  const filtered = patients.filter(p=>p.patientName.toLowerCase().includes(filter.toLowerCase()))
  filtered.forEach(p=>{
    const div=document.createElement('div')
    div.className="patient-item"
    div.innerHTML=`<div><strong>${p.patientName}</strong><div class="muted">${p.profession||''}</div></div><button data-id="${p.id}" class="ghost">Ouvrir</button>`
    listDiv.appendChild(div)
  })
}

document.getElementById('searchPatient').oninput = e=>{
  renderList(e.target.value)
}

document.addEventListener('click', async e=>{
  const btn = e.target.closest('button')
  if(!btn||!btn.dataset.id) return
  current = patients.find(p=>p.id==btn.dataset.id)
  show('dossier')
  renderDossier()
})

function renderDossier(){
  if(!current) return
  const r = document.getElementById('rapportContent')
  const blessures = current.blessures ? current.blessures.split("\n").map(b=>"- "+b).join("\n") : ""
  const invoices = current.invoices ? current.invoices.map(inv=>`- ${inv.item}: ${inv.qty} x ${inv.unitCost} $ = ${inv.total} $`).join("\n") : ""
  r.textContent = `Prénom Nom du SAMS: ${current.samsName||''}
Prénom Nom patient: ${current.patientName||''}
Date de naissance: ${current.dob||''}
Profession: ${current.profession||''}

Blessures:
${blessures}

Raison de l’hospitalisation:
${current.raison||''}

Examens:
${current.examens||''}

Factures:
${invoices}

Coût total: ${current.totalCost||0} $`
}

document.getElementById('patientForm').onsubmit=async e=>{
  e.preventDefault()
  const patient={
    samsName: form.samsName.value,
    patientName: form.patientName.value,
    dob: form.dob.value,
    profession: form.profession.value,
    blessures: form.blessures.value,
    raison: form.raison.value,
    examens: form.examens.value,
    totalCost: current ? current.totalCost||0 : 0,
    invoices: current ? current.invoices||[] : []
  }
  if(current){ await supabase.from('patients').update(patient).eq('id',current.id) }
  else{ await supabase.from('patients').insert([patient]) }
  await loadPatients()
  alert('Patient enregistré.')
  form.reset()
  show('list')
}

document.getElementById('clearForm').onclick=()=>form.reset()
document.getElementById('editPatient').onclick=()=>{
  if(!current) return
  show('new')
  Object.keys(current).forEach(k=>{if(form[k]) form[k].value=current[k]||''})
}

document.getElementById('deletePatient').onclick=async ()=>{
  if(!current) return
  if(confirm("Supprimer ce patient ?")){
    await supabase.from('patients').delete().eq('id',current.id)
    current=null
    await loadPatients()
    show('list')
  }
}

document.getElementById('printReport').onclick=()=>window.print()

document.getElementById('addInvoice').onclick=async ()=>{
  if(!current) return
  const item = prompt("Nom de l'article/service:")
  const qty = parseInt(prompt("Quantité:"),10)
  const unitCost = parseFloat(prompt("Prix unitaire:"))
  if(!item || isNaN(qty) || isNaN(unitCost)) return alert("Valeurs invalides")
  const total = qty*unitCost
  const inv = { item, qty, unitCost, total }
  current.invoices = current.invoices||[]
  current.invoices.push(inv)
  current.totalCost = (current.totalCost||0)+total
  await supabase.from('patients').update(current).eq('id',current.id)
  renderDossier()
}

document.getElementById('nav-list').onclick=()=>show('list')
document.getElementById('nav-new').onclick=()=>show('new')

loadPatients()
</script>
</body>
</html>
