<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SAMS - Gestion Patients</title>
<style>
:root{--primary:#e11d48;--primary-light:#fee2e2;--primary-dark:#991b1b;--border:#fecaca;--shadow:0 6px 18px rgba(225,29,72,0.08);--danger:#dc2626;--success:#16a34a;--warning:#ea580c}
body{font-family:Inter,system-ui;margin:0;background:url('https://i.imgur.com/A6V1lhN.jpg') no-repeat center center fixed;background-size:cover;color:#1f1f1f;position:relative;min-height:100vh}
body::before{content:"";position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,0.68);backdrop-filter:blur(4px);z-index:-1}
header{background:linear-gradient(90deg,var(--primary),var(--primary-dark));color:white;padding:16px 24px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 4px 12px rgba(225,29,72,0.15);position:relative;z-index:10}
header img{height:58px;border-radius:14px;box-shadow:0 3px 10px rgba(0,0,0,0.2)}
header h1{margin:0;font-size:20px;font-weight:700}
.logout-btn{background:#dc2626;color:white;padding:8px 16px;border-radius:8px;font-size:14px;cursor:pointer;border:none;transition:0.2s}
.logout-btn:hover{background:#b91c1c}
.container{max-width:1200px;margin:28px auto;padding:16px;position:relative;z-index:5}
.grid{display:grid;grid-template-columns:320px 1fr;gap:24px}
.card{background:rgba(255,255,255,0.88);padding:20px;border-radius:14px;box-shadow:var(--shadow);border:1px solid var(--border);backdrop-filter:blur(10px)}
.menu button{display:block;width:100%;text-align:left;padding:12px;border:0;background:none;border-radius:10px;margin-bottom:8px;cursor:pointer;transition:0.2s;font-weight:500}
.menu button:hover{background:var(--primary-light);color:var(--primary)}
.menu button.active{background:var(--primary);color:white;font-weight:600}
label{display:block;margin-top:12px;font-weight:600;font-size:14px;color:var(--primary-dark)}
input,select,textarea{width:100%;padding:10px;margin-top:6px;border-radius:8px;border:1px solid var(--border);box-sizing:border-box;font-size:14px}
input:focus,select:focus,textarea:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(225,29,72,0.15)}
textarea{min-height:100px;resize:vertical}
.row{display:flex;gap:12px;flex-wrap:wrap}
.col{flex:1;min-width:200px}
.actions{margin-top:16px;display:flex;gap:10px;flex-wrap:wrap}
button.primary{background:var(--primary);color:white;padding:12px 18px;border:0;border-radius:10px;cursor:pointer;font-weight:600;transition:0.2s}
button.primary:hover{background:var(--primary-dark)}
button.success{background:var(--success);color:white}
button.danger{background:var(--danger);color:white}
button.ghost{background:transparent;border:1.5px solid var(--border);padding:12px 18px;border-radius:10px;cursor:pointer;font-weight:500;transition:0.2s}
button.ghost:hover{border-color:var(--primary);color:var(--primary);background:var(--primary-light)}
.patient-item{padding:14px;border-radius:12px;border:1px solid var(--border);margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;cursor:pointer;transition:0.2s;position:relative}
.patient-item:hover{background:var(--primary-light);border-color:var(--primary)}
.patient-item.validated{border-left:5px solid var(--success)}
.patient-item.refused{border-left:5px solid var(--danger)}
.patient-item.pending{border-left:5px solid var(--warning)}
.status-badge{position:absolute;top:8px;right:8px;padding:4px 10px;border-radius:20px;font-size:11px;font-weight:600;color:white}
.validated .status-badge{background:var(--success)}
.refused .status-badge{background:var(--danger)}
.pending .status-badge{background:var(--warning)}
.muted{color:#6b7280;font-size:13px}
.report{white-space:pre-wrap;background:#fffafa;padding:18px;border-radius:12px;border:1px solid var(--border);font-family:monospace;font-size:14px;line-height:1.8}
.validation-comment{background:#fff3cd;padding:12px;border-radius:8px;border-left:4px solid #f59e0b;margin:15px 0;font-style:italic;color:#92400e}
.search-bar{margin:12px 0;padding:10px 14px;border-radius:10px;border:1px solid var(--border);font-size:14px}
.invoice-item{display:flex;gap:8px;align-items:center;margin:6px 0;flex-wrap:wrap}
.invoice-item span{flex:1;min-width:100px;padding:6px 10px;background:var(--primary-light);border-radius:6px;font-size:13px}
.invoice-item button{padding:4px 8px;font-size:12px;color:var(--danger)}
.error{color:var(--danger);margin:10px 0;padding:12px;background:#fee;border:1px solid #fecaca;border-radius:10px;font-size:14px}
.loading{text-align:center;color:#6b7280;padding:20px}
@media print{body::before{display:none}.grid{grid-template-columns:1fr}.card{box-shadow:none;border:1px solid #ddd}header,.menu,.actions button:not(#printReport){display:none}}
</style>
</head>
<body>
<header>
  <img src="https://i.imgur.com/N1tQTgU.png" alt="SAMS">
  <h1>SAMS - Gestion Patients</h1>
  <button id="logoutBtn" class="logout-btn">Déconnexion</button>
</header>
<div class="container">
  <div class="grid">
    <aside class="card">
      <div class="menu">
        <button id="nav-clockin">Prise de service</button>
        <button id="nav-profile">Mon profil</button>
        <button id="nav-tarifs">Tarifs & Codes Radio</button>
        <hr style="margin:16px 0; border:none; border-top:1px solid #fecaca;">
        <button id="nav-list" class="active">Liste patients</button>
        <button id="nav-new">Nouveau patient</button>
        <button id="nav-denied">Refus de soins</button>
        <button id="nav-dead">Morgue</button>
        <button id="nav-unpaid">Impayés</button>
      </div>
      <input type="text" id="searchPatient" class="search-bar" placeholder="Rechercher un patient...">
      <div id="patientList"></div>
    </aside>
    <main>
      <section id="view-list" class="card">
        <h2>Liste des patients</h2>
        <div id="listContent"><div class="loading">Connexion à Supabase...</div></div>
      </section>
      <section id="view-new" class="card" style="display:none;">
        <h2 id="formTitle">Nouveau patient</h2>
        <form id="patientForm">
          <div class="row">
            <div class="col"><label>Prénom Nom du SAMS</label><input type="text" id="samsName" required></div>
            <div class="col"><label>Prénom Nom ID du patient</label><input type="text" id="patientNameId" placeholder="ex: Jean Dupont #001" required></div>
          </div>
          <div class="row">
            <div class="col"><label>Date de naissance</label><input type="date" id="dob"></div>
            <div class="col"><label>Profession</label><input type="text" id="profession"></div>
          </div>
          <label>Antécédents médicaux (les 2 derniers)</label>
          <textarea id="antecedents" placeholder="ex: Hypertension, Diabète"></textarea>
          <label>Récapitulatif des blessures</label>
          <textarea id="blessures" placeholder="ex: Fracture tibia (grave)"></textarea>
          <label>Récapitulatif de la raison de l’hospitalisation</label>
          <textarea id="raison"></textarea>
          <label>Examens (DÉTAILLER LES OP)</label>
          <textarea id="examens" placeholder="ex: IRM x1, Radio x2"></textarea>
          <div id="formError" class="error" style="display:none;"></div>
          <div class="actions">
            <button class="primary" type="submit">Enregistrer</button>
            <button type="button" id="clearForm" class="ghost">Effacer</button>
          </div>
        </form>
      </section>
      <section id="view-dossier" class="card" style="display:none;">
        <h2>Dossier patient</h2>
        <div id="rapportContent" class="report"></div>
        <div id="validationComment" class="validation-comment" style="display:none;"></div>
        <div class="actions" id="adminActions" style="display:none;"></div>
        <div class="actions">
          <button id="addInvoiceBtn" class="primary">Ajouter une facture</button>
          <button id="editPatient" class="ghost">Modifier</button>
          <button id="deletePatient" class="danger ghost">Supprimer</button>
          <button id="printReport" class="primary">Imprimer</button>
        </div>
      </section>
    </main>
  </div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'
const supabase = createClient("https://sevrfgivcpefyykuffti.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNldnJmZ2l2Y3BlZnl5a3VmZnRpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5NDI1NTMsImV4cCI6MjA3ODUxODU1M30.YZnkSHsVWKQEhfU7xYfWyTFmtkM28Zuzdu7Y1sjBXQc")

const userData = localStorage.getItem('sams_user')
if (!userData) { window.location.href = 'login.html' }
const user = JSON.parse(userData)

document.getElementById('logoutBtn').onclick = () => {
  localStorage.removeItem('sams_user')
  window.location.href = 'login.html'
}

if (user.permission === 'admin') {
  const menu = document.querySelector('.menu')
  const adminBtn = document.createElement('button')
  adminBtn.textContent = 'Admin Panel'
  adminBtn.style.cssText = 'background:#1e40af;color:white;font-weight:600;margin-bottom:12px;'
  adminBtn.onclick = () => window.location.href = 'admin.html'
  menu.insertBefore(adminBtn, menu.firstChild)
}

document.getElementById('nav-clockin').onclick = () => window.location.href = 'clockin.html'
document.getElementById('nav-profile').onclick = () => window.location.href = 'profile.html'
document.getElementById('nav-tarifs').onclick = () => window.location.href = 'tarifs.html'
document.getElementById('nav-denied').onclick = () => window.location.href = 'denied.html'
document.getElementById('nav-dead').onclick = () => window.location.href = 'dead.html'
document.getElementById('nav-unpaid').onclick = () => window.location.href = 'unpaid.html'

async function logAction(action, target, details) {
  await supabase.from('logs').insert({ user_id: user.id, username: user.user, action, target, details })
}

const views = { list: document.getElementById('view-list'), new: document.getElementById('view-new'), dossier: document.getElementById('view-dossier') }
let patients = [], current = null, invoiceItems = []

function formatDateTime(date) { return new Date(date).toLocaleString('fr-FR') }

function show(view) {
  Object.values(views).forEach(v => v.style.display = 'none')
  views[view].style.display = 'block'
  document.querySelectorAll('.menu button').forEach(b => b.classList.remove('active'))
  if (view !== 'dossier') document.getElementById(`nav-${view}`).classList.add('active')
}

async function loadPatients() {
  const { data, error } = await supabase.from('patients').select('*').order('id', { ascending: false })
  if (error) { document.getElementById('listContent').innerHTML = `<div class="error">Erreur: ${error.message}</div>`; return }
  patients = data || []
  renderLists()
  document.querySelector('.loading')?.remove()
}

function renderLists(filter = "") {
  const filtered = patients.filter(p => (p.patientNameId || '').toLowerCase().includes(filter.toLowerCase()))
  const listHTML = filtered.map(p => {
    const status = p.validation_status || 'pending'
    const badge = status === 'validated' ? 'Validé' : status === 'refused' ? 'Refusé' : 'En attente'
    return `<div class="patient-item ${status}" onclick="openDossier(${p.id})">
      <div><strong>${p.patientNameId}</strong><div class="muted">${p.profession || '—'} • ${p.totalCost || 0}$</div></div>
      <span class="status-badge">${badge}</span>
    </div>`
  }).join('')
  document.getElementById('patientList').innerHTML = listHTML
  document.getElementById('listContent').innerHTML = listHTML || '<div class="muted">Aucun patient</div>'
}

window.openDossier = (id) => {
  current = patients.find(p => p.id === id)
  show('dossier')
  renderDossier()
}

function renderDossier() {
  const c = current
  const created = c.createdAt ? `Créé le : ${formatDateTime(c.createdAt)}` : ''
  const invoice = c.invoiceDate ? `Facture ajoutée le : ${formatDateTime(c.invoiceDate)}` : ''
  const recap = c.invoiceRecap ? ` (${c.invoiceRecap})` : ''
  const status = c.validation_status || 'pending'
  const comment = c.validation_comment ? `Commentaire admin : ${c.validation_comment}` : ''

  document.getElementById('rapportContent').textContent = `Prénom Nom du SAMS : ${c.samsName || ''}\nPrénom Nom ID du patient : ${c.patientNameId || ''}\nDate de naissance : ${c.dob || ''}\nProfession : ${c.profession || ''}\nAntécédents médicaux : ${c.antecedents || ''}\nRécapitulatif des blessures : ${c.blessures || ''}\nRaison de l’hospitalisation : ${c.raison || ''}\nExamens : ${c.examens || ''}\n${created}\n${invoice}\nCoût total : ${c.totalCost || 0}$${recap}`

  const commentDiv = document.getElementById('validationComment')
  if (status === 'refused' && comment) {
    commentDiv.textContent = comment
    commentDiv.style.display = 'block'
  } else {
    commentDiv.style.display = 'none'
  }

  const adminActions = document.getElementById('adminActions')
  adminActions.innerHTML = ''
  if (user.permission === 'admin' && status !== 'validated') {
    const validateBtn = document.createElement('button')
    validateBtn.textContent = 'Valider le dossier'
    validateBtn.className = 'primary success'
    validateBtn.onclick = () => validateDossier(true)
    
    const refuseBtn = document.createElement('button')
    refuseBtn.textContent = 'Refuser (commentaire)'
    refuseBtn.className = 'primary danger'
    refuseBtn.onclick = () => validateDossier(false)

    adminActions.appendChild(validateBtn)
    adminActions.appendChild(refuseBtn)
    adminActions.style.display = 'flex'
  } else {
    adminActions.style.display = 'none'
  }
}

async function validateDossier(isValid) {
  if (!current) return
  if (!isValid) {
    const reason = prompt("Raison du refus (obligatoire) :\nEx: Rapport incomplet, manque de détails, erreurs médicales...")
    if (!reason || reason.trim().length < 10) return alert("Tu dois écrire une raison claire (min 10 caractères)")
    
    await supabase.from('patients').update({
      validation_status: 'refused',
      validation_comment: reason.trim(),
      validated_by: user.user,
      validated_at: new Date().toISOString()
    }).eq('id', current.id)
    
    await logAction('validation_refused', 'patient', `ID: ${current.id} | ${current.patientNameId} | ${reason.trim()}`)
  } else {
    await supabase.from('patients').update({
      validation_status: 'validated',
      validation_comment: null,
      validated_by: user.user,
      validated_at: new Date().toISOString()
    }).eq('id', current.id)
    
    await logAction('validation_validated', 'patient', `ID: ${current.id} | ${current.patientNameId}`)
  }
  await loadPatients()
  renderDossier()
}

// Réinitialise la validation dès qu’on modifie le dossier
document.getElementById('patientForm').onsubmit = async e => {
  e.preventDefault()
  const p = {
    samsName: document.getElementById('samsName').value.trim(),
    patientNameId: document.getElementById('patientNameId').value.trim(),
    dob: document.getElementById('dob').value,
    profession: document.getElementById('profession').value.trim(),
    antecedents: document.getElementById('antecedents').value.trim(),
    blessures: document.getElementById('blessures').value.trim(),
    raison: document.getElementById('raison').value.trim(),
    examens: document.getElementById('examens').value.trim(),
    totalCost: current?.totalCost || 0,
    invoiceRecap: current?.invoiceRecap || '',
    createdAt: current ? current.createdAt : new Date().toISOString(),
    invoiceDate: current?.invoiceDate || null,
    validation_status: 'pending',  // ← Réinitialisation auto
    validation_comment: null,
    validated_by: null,
    validated_at: null
  }

  try {
    if (current) {
      await supabase.from('patients').update(p).eq('id', current.id)
      await logAction('update', 'patient', `ID: ${current.id} | ${p.patientNameId} | Validation réinitialisée`)
    } else {
      const { data } = await supabase.from('patients').insert([p]).select()
      await logAction('create', 'patient', `ID: ${data[0].id} | ${p.patientNameId}`)
    }
    await loadPatients(); alert("Patient enregistré"); clearForm(); show('list')
  } catch (err) {
    document.getElementById('formError').textContent = err.message
    document.getElementById('formError').style.display = 'block'
  }
}

// === Tout le reste (factures, etc.) identique ===
document.getElementById('deletePatient').onclick = async () => {
  if (!current || !confirm("Supprimer ce patient ?")) return
  await logAction('delete', 'patient', `ID: ${current.id}`)
  await supabase.from('patients').delete().eq('id', current.id)
  await loadPatients(); show('list')
}

document.getElementById('addInvoiceBtn').onclick = () => { invoiceItems = []; showInvoiceModal() }
function showInvoiceModal() {
  const modal = document.createElement('div')
  modal.style.cssText = `position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000`
  modal.innerHTML = `<div class="card" style="width:500px;max-height:80vh;overflow:auto"><h3 style="color:var(--primary)">Ajouter une facture</h3><div id="invoiceList"><div class="muted">Aucun élément</div></div><div class="row" style="margin-top:10px"><select id="itemType"><option value="blessure_légère">Blessure légère (1000$)</option><option value="blessure_moyenne">Blessure moyenne (2500$)</option><option value="blessure_grave">Blessure grave (3000$)</option><option value="IRM">IRM (500$)</option><option value="Radio">Radio (500$)</option><option value="Échographie">Échographie (500$)</option><option value="accessoire">Accessoire (2000$)</option><option value="chambre">Chambre privée (10000$)</option></select><input type="number" id="itemQty" value="1" min="1" style="width:80px"><button class="ghost" onclick="addInvoiceItem()">Ajouter</button></div><div class="actions" style="margin-top:16px"><button class="primary" onclick="saveInvoice()">Enregistrer</button><button class="ghost" onclick="this.closest('[style*=fixed]').remove()">Annuler</button></div></div>`
  document.body.appendChild(modal)
}
window.addInvoiceItem = () => {
  const type = document.getElementById('itemType').value
  const qty = parseInt(document.getElementById('itemQty').value) || 1
  const labels = { blessure_légère: "Blessure légère", blessure_moyenne: "Blessure moyenne", blessure_grave: "Blessure grave", IRM: "IRM", Radio: "Radio", Échographie: "Échographie", accessoire: "Accessoire", chambre: "Chambre privée" }
  const costs = { blessure_légère:1000, blessure_moyenne:2500, blessure_grave:3000, IRM:500, Radio:500, Échographie:500, accessoire:2000, chambre:10000 }
  invoiceItems.push({ type, label: labels[type], qty, cost: costs[type] * qty })
  document.getElementById('invoiceList').innerHTML = invoiceItems.map((i, idx) => `<div class="invoice-item"><span>${i.label} x${i.qty}</span><span>${i.cost}$</span><button onclick="invoiceItems.splice(${idx},1);addInvoiceItem.parentNode.click()">Suppr</button></div>`).join('') || '<div class="muted">Aucun</div>'
  document.getElementById('itemQty').value = 1
}
window.saveInvoice = async () => {
  if (!invoiceItems.length) return alert("Ajoute au moins un élément")
  const total = invoiceItems.reduce((a, i) => a + i.cost, 0)
  const recap = invoiceItems.map(i => `${i.qty}x ${i.label}`).join(', ')
  current.totalCost = (current.totalCost || 0) + total
  current.invoiceRecap = recap
  current.invoiceDate = new Date().toISOString()
  await supabase.from('patients').update({ totalCost: current.totalCost, invoiceRecap: recap, invoiceDate: current.invoiceDate }).eq('id', current.id)
  await logAction('invoice', 'patient', `+${total}$ | ${recap}`)
  await loadPatients(); renderDossier(); document.querySelector('[style*=fixed]')?.remove(); invoiceItems = []
}

function clearForm() { document.getElementById('patientForm').reset(); current = null; document.getElementById('formTitle').textContent = 'Nouveau patient' }
document.getElementById('editPatient').onclick = () => { if (!current) return; show('new'); document.getElementById('formTitle').textContent = 'Modifier patient'; ['samsName','patientNameId','dob','profession','antecedents','blessures','raison','examens'].forEach(id => document.getElementById(id).value = current[id] || '') }
document.getElementById('printReport').onclick = () => window.print()
document.getElementById('searchPatient').oninput = e => renderLists(e.target.value)
document.getElementById('nav-list').onclick = () => show('list')
document.getElementById('nav-new').onclick = () => { clearForm(); show('new') }

loadPatients()
</script>
</body>
</html>

