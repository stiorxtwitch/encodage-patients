<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SAMS - Refus de paiement</title>
<!-- Même CSS que unpaid.html (copié ci-dessus) -->
<style>
/* Colle exactement le même bloc <style> que dans unpaid.html */
</style>
</head>
<body>
<!-- Même structure que unpaid.html, juste les titres et champs changés -->
<header>
  <img src="https://i.imgur.com/N1tQTgU.png" alt="SAMS">
  <h1>Refus de paiement</h1>
  <a href="index.html" class="back-btn">Retour</a>
</header>
<div class="container">
  <div class="grid">
    <aside class="card">
      <div class="menu">
        <button id="nav-list" class="active">Liste refus</button>
        <button id="nav-new">Nouveau refus</button>
      </div>
      <input type="text" id="search" class="search-bar" placeholder="Rechercher...">
      <div id="patientList"></div>
    </aside>
    <main>
      <section id="view-list" class="card">
        <h2>Liste des refus</h2>
        <div id="listContent"></div>
      </section>

      <section id="view-new" class="card" style="display:none;">
        <h2 id="formTitle">Nouveau refus</h2>
        <form id="patientForm">
          <div class="row">
            <div class="col"><label>SAMS</label><input type="text" id="samsName" required></div>
            <div class="col"><label>Patient ID</label><input type="text" id="patientNameId" required></div>
          </div>
          <label>Date prise en charge</label><input type="datetime-local" id="date" required>
          <label>Récapitulatif blessures</label><textarea id="recap" required></textarea>
          <label>Raison du refus</label><textarea id="reason" required></textarea>
          <div class="actions">
            <button type="submit" class="primary">Enregistrer</button>
            <button type="button" id="clearForm" class="ghost">Effacer</button>
          </div>
        </form>
      </section>

      <section id="view-dossier" class="card" style="display:none;">
        <h2>Dossier refus</h2>
        <div id="report" class="report"></div>
        <div id="validationComment" class="validation-comment" style="display:none;"></div>
        <div id="adminActions" class="actions" style="display:none;"></div>
        <div class="actions">
          <button id="editBtn" class="ghost">Modifier</button>
          <button class="ghost" onclick="showView('list')">Retour</button>
        </div>
      </section>
    </main>
  </div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'
const supabase = createClient("https://sevrfgivcpefyykuffti.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNldnJmZ2l2Y3BlZnl5a3VmZnRpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5NDI1NTMsImV4cCI6MjA3ODUxODU1M30.YZnkSHsVWKQEhfU7xYfWyTFmtkM28Zuzdu7Y1sjBXQc")

if (!localStorage.getItem('sams_user')) window.location.href = 'login.html'
const user = JSON.parse(localStorage.getItem('sams_user'))
const isAdmin = user.permission === 'admin'

let list = [], current = null
const views = { list: document.getElementById('view-list'), form: document.getElementById('view-new'), dossier: document.getElementById('view-dossier') }

function showView(v) {
  Object.values(views).forEach(el => el.style.display = 'none')
  views[v].style.display = 'block'
  document.querySelectorAll('.menu button').forEach(b => b.classList.remove('active'))
  document.getElementById('nav-' + (v==='form'?'new':v)).classList.add('active')
}

async function load() {
  const { data } = await supabase.from('denied').select('*').order('id', { ascending: false })
  list = data || []
  renderList()
}

function renderList(filter = "") {
  const filtered = list.filter(i => i.patientNameId.toLowerCase().includes(filter.toLowerCase()))
  const html = filtered.map(i => {
    const status = i.validation_status || 'pending'
    const badge = status === 'validated' ? 'Validé' : status === 'refused' ? 'Refusé' : 'En attente'
    return `<div class="patient-item ${status}" onclick="openDossier(${i.id})">
      <div><strong>${i.patientNameId}</strong><div class="muted">${new Date(i.date).toLocaleDateString()}</div></div>
      <span class="status-badge">${badge}</span>
    </div>`
  }).join('')
  document.getElementById('patientList').innerHTML = html
  document.getElementById('listContent').innerHTML = html || '<div class="muted">Aucun refus</div>'
}

// Le reste est identique à unpaid.html (openDossier, validate, edit, submit...)

load()
</script>
</body>
</html>
