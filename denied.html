<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SAMS - Refus de soins</title>
<style>
:root{--p:#e11d48;--d:#dc2626;--s:#16a34a;--w:#ea580c;--b:#fecaca;--l:#fee2e2}
body{font-family:system-ui,Arial;margin:0;background:url('https://i.imgur.com/A6V1lhN.jpg') center/cover fixed;color:#111;min-height:100vh}
body::before{content:"";position:fixed;inset:0;background:rgba(255,255,255,0.72);backdrop-filter:blur(5px);z-index:-1}
header{background:linear-gradient(90deg,var(--p),#991b1b);color:#fff;padding:16px 24px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 4px 20px rgba(0,0,0,.15)}
header img{height:56px;border-radius:12px}
h1{margin:0;font-size:21px;font-weight:700}
.back-btn{background:var(--d);color:#fff;padding:9px 18px;border-radius:10px;border:none;cursor:pointer;transition:.2s}
.back-btn:hover{background:#b91c1c}
.container{max-width:1280px;margin:20px auto;padding:20px}
.grid{display:grid;grid-template-columns:340px 1fr;gap:24px}
.card{background:#fff;padding:24px;border-radius:16px;box-shadow:0 8px 30px rgba(0,0,0,.1);border:1px solid var(--b)}
.menu button{width:100%;text-align:left;padding:14px;border-radius:12px;border:none;margin-bottom:8px;cursor:pointer;font-weight:500;transition:.2s}
.menu button:hover{background:var(--l);color:var(--p)}
.menu button.active{background:var(--p);color:#fff;font-weight:600}
.patient-item{padding:16px;border-radius:12px;border:1px solid var(--b);margin-bottom:12px;display:flex;justify-content:space-between;align-items:center;cursor:pointer;position:relative;transition:.2s}
.patient-item:hover{background:var(--l)}
.patient-item.validated{border-left:5px solid var(--s)}
.patient-item.refused{border-left:5px solid var(--d)}
.patient-item.pending{border-left:5px solid var(--w)}
.status{position:absolute;top:10px;right:12px;padding:5px 11px;border-radius:20px;font-size:11px;color:#fff;font-weight:600}
.validated .status{background:var(--s)}
.refused .status{background:var(--d)}
.pending .status{background:var(--w)}
.report{background:#fffafa;padding:20px;border-radius:12px;border:1px solid var(--b);white-space:pre-wrap;font-family:monospace;line-height:1.8;font-size:14px}
.validation-comment{background:#fffbeb;padding:16px;border-left:4px solid #f59e0b;border-radius:8px;margin:16px 0;font-style:italic;color:#92400e}
.actions{margin-top:20px;display:flex;gap:12px;flex-wrap:wrap}
button.primary{background:var(--p);color:#fff;padding:12px 22px;border:none;border-radius:10px;cursor:pointer;font-weight:600}
button.success{background:var(--s);color:#fff}
button.danger{background:var(--d);color:#fff}
button.ghost{background:transparent;border:1.5px solid var(--b);padding:10px 20px;border-radius:10px;cursor:pointer;transition:.2s}
button.ghost:hover{border-color:var(--p);background:var(--l)}
input,textarea{width:100%;padding:12px;margin-top:8px;border-radius:10px;border:1px solid var(--b);box-sizing:border-box;font-size:14px}
input:focus,textarea:focus{border-color:var(--p);outline:none;box-shadow:0 0 0 3px rgba(225,29,72,.15)}
.row{display:flex;gap:16px;flex-wrap:wrap}
.col{flex:1;min-width:240px}
.search{margin:16px 0;padding:12px;border-radius:10px;border:1px solid var(--b);width:100%;font-size:14px}
</style>
</head>
<body>
<header>
  <img src="https://i.imgur.com/N1tQTgU.png" alt="SAMS">
  <h1>Refus de soins</h1>
  <a href="index.html" class="back-btn">Retour</a>
</header>
<div class="container">
  <div class="grid">
    <aside class="card">
      <div class="menu">
        <button id="nav-list" class="active">Liste refus</button>
        <button id="nav-new">Nouveau refus</button>
      </div>
      <input type="text" id="search" class="search" placeholder="Rechercher un patient…">
      <div id="sidebarList"></div>
    </aside>
    <main>
      <section id="list" class="card"><h2>Refus de soins</h2><div id="mainList">Chargement…</div></section>
      <section id="form" class="card" style="display:none">
        <h2 id="formTitle">Nouveau refus</h2>
        <form id="f">
          <div class="row">
            <div class="col"><label>SAMS</label><input type="text" id="samsName" required></div>
            <div class="col"><label>Patient ID</label><input type="text" id="patientID" required></div>
          </div>
          <label>Date et heure</label><input type="datetime-local" id="date" required>
          <label>Récapitulatif des blessures</label><textarea id="recap" required rows="4"></textarea>
          <label>Raison du refus</label><textarea id="raison" required rows="4"></textarea>
          <div class="actions">
            <button type="submit" class="primary">Enregistrer</button>
            <button type="button" id="cancel" class="ghost">Annuler</button>
          </div>
        </form>
      </section>
      <section id="dossier" class="card" style="display:none">
        <h2>Dossier refus de soins</h2>
        <div id="report" class="report"></div>
        <div id="comment" class="validation-comment" style="display:none"></div>
        <div id="adminBtns" class="actions" style="display:none"></div>
        <div class="actions">
          <button id="edit" class="ghost">Modifier</button>
          <button class="ghost" onclick="show('list')">Retour</button>
        </div>
      </section>
    </main>
  </div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'
const supabase = createClient('https://sevrfgivcpefyykuffti.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNldnJmZ2l2Y3BlZnl5a3VmZnRpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5NDI1NTMsImV4cCI6MjA3ODUxODU1M30.YZnkSHsVWKQEhfU7xYfWyTFmtkM28Zuzdu7Y1sjBXQc')

if (!localStorage.getItem('sams_user')) location.href = 'login.html'
const user = JSON.parse(localStorage.getItem('sams_user'))
const isAdmin = user.permission === 'admin'

let data = [], currentId = null

function show(s) {
  ['list','form','dossier'].forEach(x => document.getElementById(x).style.display = x===s ? 'block' : 'none')
  document.getElementById('nav-list').classList.toggle('active', s==='list')
  document.getElementById('nav-new').classList.toggle('active', s==='form')
}

async function load() {
  const { data: rows, error } = await supabase.from('denied').select('*').order('id', {ascending:false})
  if (error) { alert('Erreur Supabase : ' + error.message); return }
  data = rows || []
  render()
}

function render(filter='') {
  const f = data.filter(i => (i.patientID||'').toLowerCase().includes(filter.toLowerCase()))
  const html = f.map(i => {
    const s = i.validation_status || 'pending'
    const badge = s==='validated'?'Validé':s==='refused'?'Refusé':'En attente'
    return `<div class="patient-item ${s}" onclick="openDossier(${i.id})">
      <div><strong>${i.patientID}</strong><br><small>${new Date(i.date).toLocaleDateString('fr-FR')}</small></div>
      <span class="status">${badge}</span>
    </div>`
  }).join('')
  document.getElementById('sidebarList').innerHTML = html
  document.getElementById('mainList').innerHTML = html || '<p style="text-align:center;color:#888;padding:40px">Aucun refus de soins</p>'
}

window.openDossier = id => {
  const item = data.find(x => x.id === id)
  currentId = id
  document.getElementById('report').textContent = `SAMS : ${item.samsName}
Patient ID : ${item.patientID}
Date et heure : ${new Date(item.date).toLocaleString('fr-FR')}
Récapitulatif des blessures : ${item.recap}
Raison du refus : ${item.raison}`

  const c = document.getElementById('comment')
  c.style.display = (item.validation_status==='refused' && item.validation_comment) ? 'block' : 'none'
  if (c.style.display==='block') c.textContent = 'Commentaire admin : ' + item.validation_comment

  const a = document.getElementById('adminBtns')
  a.innerHTML = ''
  if (isAdmin && item.validation_status !== 'validated') {
    const v = Object.assign(document.createElement('button'), {textContent:'Valider', className:'primary success', onclick:()=>validate(true)})
    const r = Object.assign(document.createElement('button'), {textContent:'Refuser', className:'primary danger', onclick:()=>validate(false)})
    a.append(v,r)
    a.style.display = 'flex'
  }
  show('dossier')
}

async function validate(ok) {
  if (!ok) {
    const r = prompt('Raison du refus (min 10 caractères) :')
    if (!r || r.trim().length < 10) return alert('Raison trop courte')
    await supabase.from('denied').update({validation_status:'refused', validation_comment:r.trim()}).eq('id', currentId)
  } else {
    await supabase.from('denied').update({validation_status:'validated', validation_comment:null}).eq('id', currentId)
  }
  load()
}

document.getElementById('edit').onclick = () => {
  const item = data.find(x => x.id === currentId)
  document.getElementById('formTitle').textContent = 'Modifier refus'
  document.getElementById('samsName').value = item.samsName
  document.getElementById('patientID').value = item.patientID
  document.getElementById('date').value = item.date.slice(0,16)
  document.getElementById('recap').value = item.recap
  document.getElementById('raison').value = item.raison
  show('form')
}

document.getElementById('f').onsubmit = async e => {
  e.preventDefault()
  const payload = {
    samsName: document.getElementById('samsName').value.trim(),
    patientID: document.getElementById('patientID').value.trim(),
    date: document.getElementById('date').value,
    recap: document.getElementById('recap').value.trim(),
    raison: document.getElementById('raison').value.trim(),
    validation_status: 'pending',
    validation_comment: null
  }
  let error
  if (currentId) ({ error } = await supabase.from('denied').update(payload).eq('id', currentId))
  else ({ error } = await supabase.from('denied').insert([payload]))
  if (error) alert('Erreur : ' + error.message)
  else {
    document.getElementById('f').reset()
    document.getElementById('formTitle').textContent = 'Nouveau refus'
    currentId = null
    load()
    show('list')
  }
}

document.getElementById('cancel').onclick = () => { document.getElementById('f').reset(); currentId=null; document.getElementById('formTitle').textContent='Nouveau refus'; show('list') }
document.getElementById('search').oninput = e => render(e.target.value)
document.getElementById('nav-list').onclick = () => show('list')
document.getElementById('nav-new').onclick = () => { currentId=null; document.getElementById('f').reset(); document.getElementById('formTitle').textContent='Nouveau refus'; show('form') }

load()
</script>
</body>
</html>

