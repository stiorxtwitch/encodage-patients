<!-- (identique à unpaid.html, juste le nom de table "denied" et les champs adaptés) -->
<!-- Je te mets juste le script modifié, le HTML est le même que unpaid.html -->

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'
const supabase = createClient("https://sevrfgivcpefyykuffti.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNldnJmZ2l2Y3BlZnl5a3VmZnRpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5NDI1NTMsImV4cCI6MjA3ODUxODU1M30.YZnkSHsVWKQEhfU7xYfWyTFmtkM28Zuzdu7Y1sjBXQc")

if (!localStorage.getItem('sams_user')) window.location.href = 'login.html'
const user = JSON.parse(localStorage.getItem('sams_user'))
const isAdmin = user.permission === 'admin'

let items = [], current = null
const views = { list: document.getElementById('view-list'), new: document.getElementById('view-new'), dossier: document.getElementById('view-dossier') }

function show(v) { Object.values(views).forEach(x => x.style.display = 'none'); views[v].style.display = 'block'; document.querySelectorAll('.menu button').forEach(b => b.classList.remove('active')); document.getElementById(`nav-${v}`).classList.add('active') }

async function load() {
  const { data } = await supabase.from('denied').select('*').order('id', { ascending: false })
  items = data || []; render(); document.querySelector('.loading')?.remove()
}

function render(filter = "") {
  const f = items.filter(i => (i.patientID || '').toLowerCase().includes(filter.toLowerCase()))
  const html = f.map(i => {
    const status = i.validation_status || 'pending'
    const badge = status === 'validated' ? 'Validé' : status === 'refused' ? 'Refusé' : 'En attente'
    return `<div class="patient-item ${status}" onclick="openDossier(${i.id})">
      <div><strong>${i.patientID}</strong><div class="muted">${new Date(i.date).toLocaleDateString()}</div></div>
      <span class="status-badge">${badge}</span>
    </div>`
  }).join('')
  document.getElementById('list').innerHTML = html
  document.getElementById('listContent').innerHTML = html || '<div class="muted">Aucun refus</div>'
}

window.openDossier = (id) => {
  current = items.find(x => x.id === id)
  document.getElementById('report').textContent = 
`SAMS : ${current.samsName}
Patient : ${current.patientID}
Date : ${new Date(current.date).toLocaleString('fr-FR')}
Blessures : ${current.recap}
Raison du refus : ${current.raison}`

  const commentDiv = document.getElementById('validationComment')
  if (current.validation_status === 'refused' && current.validation_comment) {
    commentDiv.textContent = "Commentaire admin : " + current.validation_comment
    commentDiv.style.display = 'block'
  } else commentDiv.style.display = 'none'

  const adminDiv = document.getElementById('adminActions')
  adminDiv.innerHTML = ''
  if (isAdmin && current.validation_status !== 'validated') {
    const valBtn = document.createElement('button'); valBtn.textContent = 'Valider'; valBtn.className = 'primary success'; valBtn.onclick = () => validate(true)
    const refBtn = document.createElement('button'); refBtn.textContent = 'Refuser'; refBtn.className = 'primary danger'; refBtn.onclick = () => validate(false)
    adminDiv.append(valBtn, refBtn); adminDiv.style.display = 'flex'
  } else adminDiv.style.display = 'none'

  show('dossier')
}

async function validate(ok) {
  if (!ok) {
    const reason = prompt("Raison du refus (obligatoire) :")
    if (!reason || reason.trim().length < 10) return alert("Raison trop courte")
    await supabase.from('denied').update({ validation_status: 'refused', validation_comment: reason.trim(), validated_by: user.user, validated_at: new Date().toISOString() }).eq('id', current.id)
  } else {
    await supabase.from('denied').update({ validation_status: 'validated', validation_comment: null, validated_by: user.user, validated_at: new Date().toISOString() }).eq('id', current.id)
  }
  load()
}

document.getElementById('form').onsubmit = async e => {
  e.preventDefault()
  const p = {
    samsName: document.getElementById('samsName').value.trim(),
    patientID: document.getElementById('patientID').value.trim(),
    date: document.getElementById('date').value,
    recap: document.getElementById('recap').value.trim(),
    raison: document.getElementById('raison').value.trim(),
    validation_status: 'pending',
    validation_comment: null
  }
  if (current) await supabase.from('denied').update(p).eq('id', current.id)
  else await supabase.from('denied').insert([p])
  document.getElementById('form').reset(); current = null; load(); show('list')
}

document.getElementById('search').oninput = e => render(e.target.value)
document.getElementById('nav-list').onclick = () => show('list')
document.getElementById('nav-new').onclick = () => { current = null; document.getElementById('form').reset(); show('new') }
load()
</script>
