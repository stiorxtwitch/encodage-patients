<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SAMS - Admin Panel</title>
<style>
:root{--primary:#e11d48;--primary-dark:#991b1b;--border:#fecaca;--shadow:0 6px 18px rgba(225,29,72,0.08);--danger:#dc2626;--success:#16a34a}
body{font-family:Inter,system-ui;margin:0;background:url('https://i.imgur.com/A6V1lhN.jpg') no-repeat center center fixed;background-size:cover;color:#1f1f1f;min-height:100vh}
body::before{content:"";position:fixed;inset:0;background:rgba(255,255,255,0.68);backdrop-filter:blur(4px);z-index:-1}
header{background:linear-gradient(90deg,var(--primary),var(--primary-dark));color:white;padding:16px 24px;display:flex;align-items:center;justify-content:space-between;position:relative;z-index:10}
header img{height:58px;border-radius:14px;box-shadow:0 3px 10px rgba(0,0,0,0.2)}
h1{margin:0;font-size:20px;font-weight:700}
.back-btn{background:#dc2626;color:white;padding:8px 16px;border-radius:8px;font-size:14px;cursor:pointer;border:none;transition:0.2s}
.back-btn:hover{background:#b91c1c}
.container{max-width:1100px;margin:40px auto;padding:20px}
.card{background:rgba(255,255,255,0.94);padding:32px;border-radius:16px;box-shadow:var(--shadow);border:1px solid var(--border);backdrop-filter:blur(12px);margin-bottom:32px}
h2{color:var(--primary-dark);margin-top:0}
table{width:100%;border-collapse:collapse;margin-top:16px}
th,td{padding:12px 10px;border-bottom:1px solid #eee;text-align:left;font-size:14px}
th{background:#fff5f5;font-weight:600;color:var(--primary-dark)}
.btn-danger{background:var(--danger);color:white;padding:12px 24px;border:none;border-radius:10px;cursor:pointer;font-weight:600;font-size:16px}
.btn-danger:hover{background:#b91c1c}
.action-create{color:var(--success)}
.action-update{color:#ea580c}
.action-delete,.action-reset_servicetime{color:var(--danger)}
.action-login{color:#2563eb}
.action-invoice,.action-clock_out{color:#7c3aed}
</style>
</head>
<body>
<header>
  <img src="https://i.imgur.com/N1tQTgU.png" alt="SAMS">
  <h1>SAMS - Admin Panel</h1>
  <a href="index.html" class="back-btn">Retour</a>
</header>

<div class="container">

  <!-- TEMPS DE SERVICE -->
  <div class="card">
    <h2>Temps de service des utilisateurs</h2>
    <button onclick="resetAllTimes()" class="btn-danger">Réinitialiser TOUS les temps de service à 0</button>
    <table id="timeTable" style="margin-top:20px">
      <thead><tr><th>Utilisateur</th><th>Temps total</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- JOURNAL D'ACTIVITÉ -->
  <div class="card">
    <h2>Journal d’activité (100 dernières actions)</h2>
    <table id="logsTable">
      <thead>
        <tr><th>Date</th><th>Utilisateur</th><th>Action</th><th>Cible</th><th>Détails</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'
const supabase = createClient("https://sevrfgivcpefyykuffti.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNldnJmZ2l2Y3BlZnl5a3VmZnRpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5NDI1NTMsImV4cCI6MjA3ODUxODU1M30.YZnkSHsVWKQEhfU7xYfWyTFmtkM28Zuzdu7Y1sjBXQc")

const user = JSON.parse(localStorage.getItem('sams_user') || '{}')
if (!user || user.permission !== 'admin') {
  alert("Accès refusé - Admin uniquement")
  window.location.href = 'login.html'
}

// CHARGEMENT DES TEMPS
async function loadServiceTimes() {
  const { data } = await supabase.from('login').select('user,servicetime').order('user')
  const tbody = document.querySelector('#timeTable tbody')
  tbody.innerHTML = data.map(u => {
    const h = Math.floor((u.servicetime || 0)/60)
    const m = (u.servicetime || 0)%60
    return `<tr><td><strong>${u.user}</strong></td><td>${h}h ${m}min</td></tr>`
  }).join('')
}

// LE BOUTON QUI REMET VRAIMENT TOUT À 0 (version blindée)
window.resetAllTimes = async () => {
  const reason = prompt("REINITIALISATION COMPLÈTE DES TEMPS DE SERVICE\n\nCette action va remettre le servicetime de TOUS les utilisateurs à 0.\n\nRaison obligatoire (sera enregistrée dans les logs) :")
  if (!reason || reason.trim() === "") return alert("Raison obligatoire !")

  if (!confirm("Confirmer la réinitialisation de TOUS les temps à 0 ?")) return

  // Méthode la plus fiable : update sans filtre = touche toute la table
  const { error } = await supabase
    .from('login')
    .update({ servicetime: 0 })

  if (error) {
    alert("Erreur Supabase : " + error.message)
    return
  }

  // Log de l'action
  await supabase.from('logs').insert({
    user_id: user.id,
    username: user.user,
    action: 'reset_servicetime',
    target: 'tous_les_utilisateurs',
    details: `Raison : ${reason.trim()}`
  })

  alert("TOUS les temps de service ont été remis à 0 avec succès !")
  loadServiceTimes()
}

// JOURNAL D'ACTIVITÉ
async function loadLogs() {
  const { data } = await supabase.from('logs').select('*').order('created_at', { ascending: false }).limit(100)
  const tbody = document.querySelector('#logsTable tbody')
  tbody.innerHTML = data.map(log => {
    const date = new Date(log.created_at).toLocaleString('fr-FR')
    const actionLabel = {
      login: 'Connexion', create: 'Création', update: 'Modification',
      delete: 'Suppression', invoice: 'Facture', clock_out: 'Fin de service',
      reset_servicetime: 'Réinit. temps service'
    }[log.action] || log.action
    return `<tr>
      <td>${date}</td>
      <td><strong>${log.username}</strong></td>
      <td><span class="action-${log.action}">${actionLabel}</span></td>
      <td>${log.target || '—'}</td>
      <td>${log.details || '—'}</td>
    </tr>`
  }).join('')
}

loadServiceTimes()
loadLogs()
</script>
</body>
</html>
