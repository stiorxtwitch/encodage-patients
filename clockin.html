<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SAMS - Prise de service</title>
<style>
:root{--primary:#e11d48;--primary-dark:#991b1b;--border:#fecaca;--shadow:0 6px 18px rgba(225,29,72,0.08);--danger:#dc2626}
body{font-family:Inter,system-ui;margin:0;background:url('https://i.imgur.com/A6V1lhN.jpg') no-repeat center center fixed;background-size:cover;color:#1f1f1f;min-height:100vh}
body::before{content:"";position:fixed;inset:0;background:rgba(255,255,255,0.68);backdrop-filter:blur(4px);z-index:-1}
header{background:linear-gradient(90deg,var(--primary),var(--primary-dark));color:white;padding:16px 24px;display:flex;align-items:center;justify-content:space-between;position:relative;z-index:10}
header img{height:58px;border-radius:14px;box-shadow:0 3px 10px rgba(0,0,0,0.2)}
h1{margin:0;font-size:20px;font-weight:700}
.back-btn{background:#dc2626;color:white;padding:8px 16px;border-radius:8px;font-size:14px;cursor:pointer;border:none;transition:0.2s}
.back-btn:hover{background:#b91c1c}
.container{max-width:800px;margin:80px auto;padding:20px}
.card{background:rgba(255,255,255,0.94);padding:40px;border-radius:16px;box-shadow:var(--shadow);text-align:center;border:1px solid var(--border);backdrop-filter:blur(12px)}
button.primary{background:var(--primary);color:white;padding:16px 36px;border:none;border-radius:12px;font-size:19px;cursor:pointer;margin:15px;font-weight:600;transition:0.2s}
button.primary:hover{background:var(--primary-dark)}
#timer{font-size:56px;font-weight:bold;margin:30px 0;color:var(--primary-dark);font-family:monospace}
#recapForm{margin-top:40px;padding:20px;background:#f9f9f9;border-radius:12px;display:none}
.item{display:flex;justify-content:space-between;align-items:center;background:white;padding:12px;border-radius:8px;margin:8px 0;box-shadow:0 2px 6px rgba(0,0,0,0.05)}
.item button{color:var(--danger);background:none;border:none;cursor:pointer;font-size:20px}
</style>
</head>
<body>
<header>
  <img src="https://i.imgur.com/N1tQTgU.png" alt="SAMS">
  <h1>Prise de service</h1>
  <a href="index.html" class="back-btn">Retour</a>
</header>

<div class="container">
  <div class="card">
    <h2 id="statusText">Prêt à prendre ton service ?</h2>
    <div id="timer">00:00:00</div>
    
    <button class="primary" id="startBtn">Prise de service</button>

    <div id="recapForm">
      <h3 style="color:var(--primary)">Récapitulatif des interventions</h3>
      <div id="itemsList"><div class="muted">Aucune intervention</div></div>
      
      <div style="margin:20px 0;display:flex;gap:10px;flex-wrap:wrap;justify-content:center">
        <select id="itemType">
          <option>Blessure légère</option>
          <option>Blessure moyenne</option>
          <option>Blessure grave</option>
          <option>IRM</option>
          <option>Radio</option>
          <option>Échographie</option>
          <option>Accessoire</option>
          <option>Chambre privée</option>
        </select>
        <input type="number" id="itemQty" value="1" min="1" style="width:80px">
        <button class="ghost" onclick="addItem()">Ajouter</button>
      </div>

      <button class="primary" onclick="endShift()" style="background:#16a34a;margin-top:30px">Fin de service</button>
    </div>
  </div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'
const supabase = createClient("https://sevrfgivcpefyykuffti.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNldnJmZ2l2Y3BlZnl5a3VmZnRpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5NDI1NTMsImV4cCI6MjA3ODUxODU1M30.YZnkSHsVWKQEhfU7xYfWyTFmtkM28Zuzdu7Y1sjBXQc")

if (!localStorage.getItem('sams_user')) window.location.href = 'login.html'
const user = JSON.parse(localStorage.getItem('sams_user'))

// Récupération persistante
let items = JSON.parse(localStorage.getItem('current_shift_items') || '[]')
let startTime = localStorage.getItem('shift_start_time')

let timerInterval = null

function updateTimer() {
  if (!startTime) return
  const elapsed = Math.floor((Date.now() - new Date(startTime)) / 1000)
  const h = String(Math.floor(elapsed / 3600)).padStart(2, '0')
  const m = String(Math.floor((elapsed % 3600) / 60)).padStart(2, '0')
  const s = String(elapsed % 60).padStart(2, '0')
  document.getElementById('timer').textContent = `${h}:${m}:${s}`
}

function startTimer() {
  timerInterval = setInterval(updateTimer, 500)
  updateTimer()
}

// Au chargement de la page
if (startTime) {
  document.getElementById('statusText').textContent = "Service en cours depuis " + new Date(startTime).toLocaleTimeString('fr-FR')
  document.getElementById('startBtn').style.display = 'none'
  document.getElementById('recapForm').style.display = 'block'
  renderItems()
  startTimer()
}

document.getElementById('startBtn').onclick = () => {
  startTime = new Date().toISOString()
  localStorage.setItem('shift_start_time', startTime)
  localStorage.setItem('current_shift_items', '[]')
  items = []
  location.reload()
}

window.addItem = () => {
  const type = document.getElementById('itemType').value
  const qty = parseInt(document.getItemById('itemQty').value) || 1
  items.push({ type, qty })
  localStorage.setItem('current_shift_items', JSON.stringify(items))
  renderItems()
}

function renderItems() {
  const list = document.getElementById('itemsList')
  list.innerHTML = items.length ? items.map((it, i) => `
    <div class="item">
      <span>${it.qty}x ${it.type}</span>
      <button onclick="items.splice(${i},1); localStorage.setItem('current_shift_items', JSON.stringify(items)); renderItems()">×</button>
    </div>
  `).join('') : '<div class="muted">Aucune intervention</div>'
}

window.endShift = async () => {
  if (!startTime) return
  
  const endTime = new Date()
  const duration = Math.floor((endTime - new Date(startTime)) / 60000)

  const recap = {}
  items.forEach(i => recap[i.type] = (recap[i.type] || 0) + i.qty)

  if (!confirm(`Terminer le service ?\nDurée: ${duration} minutes\nInterventions: ${JSON.stringify(recap)}`)) return

  try {
    await supabase.from('shifts').insert({
      user_id: user.id,
      username: user.user,
      start_time: startTime,
      end_time: endTime.toISOString(),
      duration_minutes: duration,
      recap
    })

    await supabase.rpc('increment_servicetime', { userid: user.id, minutes: duration })

    await supabase.from('logs').insert({
      user_id: user.id,
      username: user.user,
      action: 'clock_out',
      details: `Durée: ${duration} min | Interventions: ${JSON.stringify(recap)}`
    })

    localStorage.removeItem('shift_start_time')
    localStorage.removeItem('current_shift_items')
    clearInterval(timerInterval)
    alert(`Service terminé ! ${duration} minutes ajoutées à ton temps total`)
    location.reload()
  } catch (e) {
    alert("Erreur: " + e.message)
  }
}

// Démarrage auto si déjà en service
startTimer()
renderItems()
</script>
</body>
</html>
