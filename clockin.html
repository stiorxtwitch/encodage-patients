<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SAMS - Prise de service</title>
<style>
:root{--primary:#e11d48;--primary-dark:#991b1b;--border:#fecaca;--shadow:0 6px 18px rgba(225,29,72,0.08);--danger:#dc2626;--overlay:rgba(255,255,255,0.68)}
body{font-family:Inter,system-ui;margin:0;background:url('https://i.imgur.com/A6V1lhN.jpg') no-repeat center center fixed;background-size:cover;color:#1f1f1f;position:relative;min-height:100vh}
body::before{content:"";position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,0.68);backdrop-filter:blur(4px);z-index:-1}
header{background:linear-gradient(90deg,var(--primary),var(--primary-dark));color:white;padding:16px 24px;display:flex;align-items:center;justify-content:space-between;position:relative;z-index:10}
header img{height:58px;border-radius:14px;box-shadow:0 3px 10px rgba(0,0,0,0.2)}
h1{margin:0;font-size:20px;font-weight:700;color:white}
.back-btn{background:#dc2626;color:white;padding:8px 16px;border-radius:8px;font-size:14px;cursor:pointer;border:none;transition:0.2s}
.back-btn:hover{background:#b91c1c}
.container{max-width:800px;margin:60px auto;padding:16px}
.card{background:rgba(255,255,255,0.92);padding:32px;border-radius:16px;box-shadow:var(--shadow);text-align:center}
button.primary{background:var(--primary);color:white;padding:16px 32px;border:none;border-radius:12px;font-size:18px;cursor:pointer;margin:20px;transition:0.2s}
button.primary:hover{background:var(--primary-dark)}
#recapForm{display:none;margin-top:30px}
.item-row{display:flex;align-items:center;gap:12px;margin:12px 0}
.item-row select, .item-row select, .item-row input{width:100%}
.item-row input{width:80px}
#itemsList{margin:20px 0}
.item{display:flex;justify-content:space-between;align-items:center;background:#f8f8f8;padding:10px;border-radius:8px;margin:8px 0}
</style>
</head>
<body>
<header>
  <img src="https://i.imgur.com/N1tQTgU.png" alt="SAMS">
  <h1>Prise de service</h1>
  <a href="index.html" class="back-btn">Retour</a>
</a>
</header>
<div class="container">
  <div class="card">
    <h2 id="status">Prêt à prendre ton service ?</h2>
    <p id="timer">00:00:00</p>
    <button class="primary" id="clockBtn">Prise de service</button>

    <div id="recapForm">
      <h3>Récapitulatif des interventions</h3>
      <div id="itemsList"></div>
      <div class="item-row">
        <select id="itemType">
          <option value="blessure_legere">Blessure légère</option>
          <option value="blessure_moyenne">Blessure moyenne</option>
          <option value="blessure_grave">Blessure grave</option>
          <option value="irm">IRM</option>
          <option value="radio">Radio</option>
          <option value="echographie">Échographie</option>
          <option value="accessoire">Accessoire</option>
          <option value="chambre">Chambre privée</option>
        </select>
        <input type="number" id="itemQty" value="1" min="1" style="width:80px">
        <button class="ghost" onclick="addItem()">Ajouter</button>
      </div>
      <button class="primary" onclick="endShift()">Fin de service</button>
    </div>
  </div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

const SUPABASE_URL = "https://sevrfgivcpefyykuffti.supabase.co"
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNldnJmZ2l2Y3BlZnl5a3VmZnRpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5NDI1NTMsImV4cCI6MjA3ODUxODU1M30.YZnkSHsVWKQEhfU7xYfWyTFmtkM28Zuzdu7Y1sjBXQc"
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY)

if (!localStorage.getItem('sams_user')) window.location.href = 'login.html'
const user = JSON.parse(localStorage.getItem('sams_user'))

let startTime = null
let timerInterval = null
let items = []

document.getElementById('clockBtn').onclick = () => {
  startTime = new Date()
  document.getElementById('status').textContent = `Service commencé à ${startTime.toLocaleTimeString('fr-FR')}`
  document.getElementById('clockBtn').style.display = 'display:none'
  document.getElementById('recapForm').style.display = 'block'

  timerInterval = setInterval(() => {
    const elapsed = Math.floor((new Date() - startTime) / 1000)
    const h = String(Math.floor(elapsed / 3600)).padStart(2, '0')
    const m = String(Math.floor((elapsed % 3600) / 60)).padStart(2, '0')
    const s = String(elapsed % 60).padStart(2, '0')
    document.getElementById('timer').textContent = `${h}:${m}:${s}`
  }, 1000)
}

window.addItem = () => {
  const type = document.getElementById('itemType').value
  const qty = parseInt(document.getElementById('itemQty').value) || 1
  const labels = { blessure_legere: "Blessure légère", blessure_moyenne: "Blessure moyenne", blessure_grave: "Blessure grave", irm: "IRM", radio: "Radio", echographie: "Échographie", accessoire: "Accessoire", chambre: "Chambre privée" }
  items.push({ type, qty, label: labels[type] })
  updateItemsList()
}

function updateItemsList() {
  const list = document.getElementById('itemsList')
  list.innerHTML = items.map((item, i) => `
    <div class="item">
      <span>${item.label} x${item.qty}</span>
      <button class="ghost" style="color:var(--danger)" onclick="items.splice(${i},1); updateItemsList()">Suppr</button>
    </div>
  `).join('') || '<div class="muted">Aucune intervention</div>'
}

window.endShift = async () => {
  if (!startTime) return
  const endTime = new Date()
  const duration = Math.floor((endTime - startTime) / 60000) // minutes

  const recapObj = {}
  items.forEach(i => recapObj[i.type] = (recapObj[i.type] || 0) + i.qty)

  try {
    // Ajouter le shift
    await supabase.from('shifts').insert({
      user_id: user.id,
      username: user.user,
      start_time: startTime.toISOString(),
      end_time: endTime.toISOString(),
      duration_minutes: duration,
      recap: recapObj
    })

    // Mettre à jour le temps total
    await supabase.rpc('increment_servicetime', { userid: user.id, minutes: duration })

    await supabase.from('logs').insert({
      user_id: user.id,
      username: user.user,
      action: 'clock_out',
      details: `Durée: ${duration} min | Interventions: ${JSON.stringify(recapObj)}`
    })

    alert(`Service terminé ! Temps: ${duration} minutes`)
    location.reload()
  } catch (err) {
    alert("Erreur: " + err.message)
  }
}

// Si déjà en service (au cas où page rechargée)
if (localStorage.getItem('shift_start')) {
  startTime = new Date(localStorage.getItem('shift_start'))
  document.getElementById('status').textContent = `Service en cours depuis ${startTime.toLocaleTimeString('fr-FR')}`
  document.getElementById('clockBtn').style.display = 'none'
  document.getElementById('recapForm').style.display = 'block'
  // relancer le timer...
}
</script>
</body>
</html>
